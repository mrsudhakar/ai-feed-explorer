<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Feed Explorer — OPML -> Grouped RSS</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--text:#e6eef8}
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;border-radius:8px}
  body{margin:0;background:linear-gradient(180deg,#071023 0%, #07182a 100%);color:var(--text);padding:24px}
  .app{max-width:1100px;margin:0 auto}
  header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--card);padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
  .input, .select, button{padding:8px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
  .small{font-size:13px}
  .opml-area{width:420px;height:110px;background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:8px;color:var(--muted);resize:vertical}
  .feeds-list{max-height:220px;overflow:auto;margin-top:8px;padding-right:4px}
  .feed-item{display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.02)}
  .main{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:18px}
  .groups{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .chip{background:rgba(255,255,255,0.03);padding:8px 10px;font-weight:600;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .chip.active{background:linear-gradient(90deg,var(--accent),#4f46e5);color:#fff}
  .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
  .items{display:grid;gap:6px}
  .item{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:10px;border-left:4px solid rgba(0,0,0,0.25)}
  .item h3{margin:0;font-size:15px}
  .item p{margin:6px 0 0;color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .search{flex:1}
  .tiny{font-size:12px;padding:6px 8px}
  .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .hint{color:var(--muted);font-size:13px}
  .footer{margin-top:14px;color:var(--muted);font-size:13px}
  a {color:inherit;text-decoration:underline}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>AI Feed Explorer</h1>
      <div class="meta">OPML → grouped RSS | Group by 1hr / 6hr / 12hr / 24hr / 7d / 30d</div>
    </header>

    <div class="main">
      <!-- LEFT: OPML & Feeds -->
      <div>
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <strong>Import OPML / Feeds</strong>
            <div style="margin-left:auto" class="hint">Paste OPML or upload file</div>
          </div>

          <textarea id="opml" placeholder="Paste OPML here (or upload file)" class="opml-area"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="file" type="file" accept=".opml,.xml" />
            <button id="parse" class="input small">Parse OPML</button>
            <button id="add-manual" class="input small">Add Feed URL</button>
          </div>

          <div class="feeds-list card" id="feedsList" style="margin-top:8px">
            <!-- feed items injected here -->
            <div class="hint">No feeds loaded yet.</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="fetchAll" class="input small">Fetch feeds</button>
            <div id="loadingIndicator" style="display:none;margin-left:auto" class="spinner"></div>
          </div>
          <div class="hint" style="margin-top:8px">If a feed fails, try the server proxy option (instructions in footer).</div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Saved lists</strong>
          <div style="margin-top:8px">
            <button id="saveList" class="input tiny">Save current OPML to local</button>
            <button id="loadList" class="input tiny">Load saved</button>
            <button id="clearSaved" class="input tiny">Clear saved</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Proxy / Scale notes</strong>
          <p class="hint" style="margin-top:8px">
            Public proxy used for demo: <code>https://api.allorigins.win/raw?url=</code>.
            For production, deploy a serverless fetch (Netlify/Vercel/AWS Lambda) to avoid CORS and caching limits.
          </p>
        </div>
      </div>

      <!-- RIGHT: Controls & Results -->
      <div>
        <div class="card">
          <div class="toolbar">
            <div class="groups" role="tablist" aria-label="grouping options" id="groupChips">
              <div class="chip active" data-hours="1">1 hr</div>
              <div class="chip" data-hours="6">6 hr</div>
              <div class="chip" data-hours="12">12 hr</div>
              <div class="chip" data-hours="24">24 hr</div>
              <div class="chip" data-hours="168">7 days</div>
              <div class="chip" data-hours="720">30 days</div>
            </div>

            <input id="search" class="input search small" placeholder="Search title or summary" />
            <select id="sort" class="select small">
              <option value="new">Newest</option>
              <option value="old">Oldest</option>
            </select>
          </div>

          <div id="resultsMeta" class="meta">No items loaded.</div>
          <div id="items" class="items"></div>
        </div>

        <div class="footer card" style="margin-top:12px">
          <div><strong>Embed / Share</strong></div>
          <ol style="margin:8px 0 0 18px">
            <li>Host this HTML file on Netlify / GitHub Pages.</li>
            <li>Embed via an &lt;iframe&gt; pointing to that URL (instructions below).</li>
          </ol>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>
  </div>

<script>
/* === Simple AI Feed Explorer — MVP JS ===
   - Parses OPML (file or paste)
   - Fetches each feed via public proxy fallback (api.allorigins.win)
   - Parses RSS/Atom XML using DOMParser
   - Normalizes items and groups them into selected time window
   - Notes: for production use, replace proxy with serverless fetch + caching
*/

// STATE
const state = {
  feeds: [],         // {title, url}
  items: [],         // normalized items
  groupHours: 1,
  loading: false
};

// DOM refs
const opmlArea = document.getElementById('opml');
const fileInput = document.getElementById('file');
const parseBtn = document.getElementById('parse');
const feedsList = document.getElementById('feedsList');
const fetchAllBtn = document.getElementById('fetchAll');
const loadingIndicator = document.getElementById('loadingIndicator');
const itemsEl = document.getElementById('items');
const groupChips = document.getElementById('groupChips');
const searchInput = document.getElementById('search');
const sortSelect = document.getElementById('sort');
const resultsMeta = document.getElementById('resultsMeta');
const saveListBtn = document.getElementById('saveList');
const loadListBtn = document.getElementById('loadList');
const clearSavedBtn = document.getElementById('clearSaved');
const addManualBtn = document.getElementById('add-manual');

// UTILS
const PROXY = 'https://api.allorigins.win/raw?url='; // public demo proxy
function now() { return new Date(); }
function isoToDate(s){ const d=new Date(s); if(!isNaN(d)) return d; try{ return new Date(Date.parse(s)); }catch(e){return null;} }
function showLoading(on){
  state.loading = !!on;
  loadingIndicator.style.display = on ? 'block' : 'none';
}

// OPML PARSING
function parseOPMLText(text){
  try{
    const doc = new DOMParser().parseFromString(text, 'text/xml');
    const outlines = Array.from(doc.querySelectorAll('outline'));
    const feeds = [];
    outlines.forEach(o=>{
      const xmlUrl = o.getAttribute('xmlUrl') || o.getAttribute('url');
      const title = o.getAttribute('title') || o.getAttribute('text') || (o.textContent || '').trim();
      if(xmlUrl) feeds.push({title: title || xmlUrl, url: xmlUrl});
    });
    return feeds;
  }catch(e){
    return [];
  }
}

// Render feeds list
function renderFeeds(){
  if(state.feeds.length === 0){
    feedsList.innerHTML = '<div class="hint">No feeds loaded yet.</div>';
    return;
  }
  feedsList.innerHTML = '';
  state.feeds.forEach((f, idx)=>{
    const div = document.createElement('div');
    div.className = 'feed-item';
    div.innerHTML = `
      <div style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(f.title)}</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="tiny" data-idx="${idx}" onclick="removeFeed(event)">Remove</button>
        <button class="tiny" data-idx="${idx}" onclick="fetchSingleFeed(event)">Fetch</button>
      </div>`;
    feedsList.appendChild(div);
  });
}

// Remove feed (global fn used in template)
window.removeFeed = function(ev){
  const idx = +ev.target.getAttribute('data-idx');
  state.feeds.splice(idx,1);
  renderFeeds();
};

// Add manual feed
addManualBtn.addEventListener('click', ()=>{
  const url = prompt('Enter feed URL (http/https):');
  if(url && url.trim()){
    state.feeds.push({title: url, url: url.trim()});
    renderFeeds();
  }
});

// FETCH FEEDS
async function fetchFeed(url){
  // try direct fetch first (may fail due CORS)
  try{
    const resp = await fetch(url, {method:'GET'});
    if(resp.ok){
      const txt = await resp.text();
      if(txt && txt.length>10) return txt;
    }
  }catch(e){ /* ignore and fallback */ }

  // fallback to public proxy
  try{
    const proxyUrl = PROXY + encodeURIComponent(url);
    const resp = await fetch(proxyUrl);
    if(!resp.ok) throw new Error('proxy fail '+resp.status);
    const txt = await resp.text();
    return txt;
  }catch(e){
    console.warn('both direct and proxy failed for', url, e);
    throw new Error('Fetch failed (CORS/proxy): ' + e.message);
  }
}

// parse RSS/Atom XML string to items
function parseFeedXml(xmlString, feedMeta){
  const doc = new DOMParser().parseFromString(xmlString, 'text/xml');
  const items = [];
  // support RSS <item>
  const rssItems = Array.from(doc.querySelectorAll('item'));
  if(rssItems.length>0){
    rssItems.forEach(it=>{
      const title = (it.querySelector('title') && it.querySelector('title').textContent) || '';
      const link = (it.querySelector('link') && it.querySelector('link').textContent) || (it.querySelector('enclosure') && it.querySelector('enclosure').getAttribute('url')) || '';
      const pub = (it.querySelector('pubDate') && it.querySelector('pubDate').textContent) || (it.querySelector('published') && it.querySelector('published').textContent) || '';
      const desc = (it.querySelector('description') && it.querySelector('description').textContent) || (it.querySelector('summary') && it.querySelector('summary').textContent) || '';
      items.push({title, link, pub, desc, source: feedMeta.title || feedMeta.url});
    });
    return items;
  }
  // Atom <entry>
  const atomItems = Array.from(doc.querySelectorAll('entry'));
  if(atomItems.length>0){
    atomItems.forEach(it=>{
      const title = (it.querySelector('title') && it.querySelector('title').textContent) || '';
      const linkEl = it.querySelector('link[rel="alternate"]') || it.querySelector('link');
      const link = linkEl ? (linkEl.getAttribute('href') || '') : '';
      const pub = (it.querySelector('updated') && it.querySelector('updated').textContent) || (it.querySelector('published') && it.querySelector('published').textContent) || '';
      const desc = (it.querySelector('summary') && it.querySelector('summary').textContent) || (it.querySelector('content') && it.querySelector('content').textContent) || '';
      items.push({title, link, pub, desc, source: feedMeta.title || feedMeta.url});
    });
    return items;
  }
  // fallback: try to get title of doc
  const fallbackTitle = doc.querySelector('title') && doc.querySelector('title').textContent;
  return [{title: fallbackTitle || feedMeta.title, link: feedMeta.url, pub: '', desc:'', source: feedMeta.title || feedMeta.url}];
}

// Normalize items and convert dates
function normalizeItems(rawItems){
  return rawItems.map(it=>{
    const parsed = isoToDate(it.pub) || null;
    return {
      title: it.title || '(no title)',
      link: it.link || '#',
      summary: (it.desc || '').replace(/(<([^>]+)>)/ig, '').slice(0, 400),
      date: parsed,
      ts: parsed ? parsed.getTime() : Date.now(),
      source: it.source || 'unknown'
    };
  });
}

// Fetch single feed (UI)
window.fetchSingleFeed = async function(ev){
  const idx = +ev.target.getAttribute('data-idx');
  const feed = state.feeds[idx];
  if(!feed) return alert('feed not found');
  try{
    showLoading(true);
    const xml = await fetchFeed(feed.url);
    const parsed = parseFeedXml(xml, feed);
    const normalized = normalizeItems(parsed);
    state.items = state.items.concat(normalized);
    dedupeAndSort();
    renderItems();
  }catch(e){
    alert('Failed to fetch feed: ' + e.message + '\nSee console for details.');
    console.error(e);
  }finally{ showLoading(false); }
};

// Fetch all feeds
fetchAllBtn.addEventListener('click', async ()=>{
  if(state.feeds.length === 0) return alert('Load OPML or add feeds first.');
  showLoading(true);
  const allRaw = [];
  for(const f of state.feeds){
    try{
      const xml = await fetchFeed(f.url);
      const parsed = parseFeedXml(xml, f);
      allRaw.push(...parsed);
    }catch(err){
      console.warn('feed fetch failed', f.url, err);
      // append a placeholder item telling user to use server proxy
      allRaw.push({title:`(failed) ${f.title}`, link:f.url, pub:'', desc:'Failed to fetch feed due to CORS or network. Consider adding to server-side proxy.', source:f.title});
    }
  }
  state.items = state.items.concat(normalizeItems(allRaw));
  dedupeAndSort();
  renderItems();
  showLoading(false);
});

// Dedupe by link+title
function dedupeAndSort(){
  const map = new Map();
  state.items.forEach(it=>{
    const key = (it.link||'') + '::' + (it.title||'');
    if(!map.has(key)) map.set(key, it);
  });
  const arr = Array.from(map.values());
  arr.sort((a,b)=>b.ts - a.ts);
  state.items = arr;
}

// Render grouped items
function renderItems(){
  const q = (searchInput.value || '').toLowerCase().trim();
  const filtered = state.items.filter(it=>{
    if(!it) return false;
    if(q === '') return true;
    return (it.title || '').toLowerCase().includes(q) || (it.summary || '').toLowerCase().includes(q) || (it.source || '').toLowerCase().includes(q);
  });

  const groupHours = state.groupHours;
  const nowTs = Date.now();
  const msWindow = groupHours * 3600 * 1000;

  // group by bucket: within msWindow from now
  const itemsInWindow = filtered.filter(it => (nowTs - (it.ts || nowTs)) <= msWindow);

  // If sort old->new or new->old
  if(sortSelect.value === 'new') itemsInWindow.sort((a,b)=>b.ts - a.ts);
  else itemsInWindow.sort((a,b)=>a.ts - b.ts);

  // UI meta
  resultsMeta.textContent = `${itemsInWindow.length} items in last ${groupHours >= 24 ? (groupHours/24 + ' days') : groupHours + ' hrs'} — ${state.feeds.length} feeds loaded`;

  // Render
  itemsEl.innerHTML = '';
  if(itemsInWindow.length === 0){
    itemsEl.innerHTML = '<div class="hint">No items in this time window.</div>';
    return;
  }

  itemsInWindow.forEach(it=>{
    const d = it.date ? (new Date(it.date)).toLocaleString() : 'Unknown date';
    const container = document.createElement('div');
    container.className = 'item';
    container.innerHTML = `
      <h3><a href="${escapeHtml(it.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title)}</a></h3>
      <div class="meta">${escapeHtml(it.source)} · ${escapeHtml(d)}</div>
      <p>${escapeHtml(it.summary || '').slice(0,300)}</p>
    `;
    itemsEl.appendChild(container);
  });
}

// event: group chips
groupChips.addEventListener('click', (ev)=>{
  const chip = ev.target.closest('.chip');
  if(!chip) return;
  Array.from(groupChips.querySelectorAll('.chip')).forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  state.groupHours = +chip.getAttribute('data-hours');
  renderItems();
});

// search & sort
searchInput.addEventListener('input', debounce(()=>renderItems(), 220));
sortSelect.addEventListener('change', ()=>renderItems());

// parse OPML button & file upload
parseBtn.addEventListener('click', ()=>{
  const text = opmlArea.value.trim();
  if(!text) return alert('Paste your OPML or upload file first.');
  const feeds = parseOPMLText(text);
  if(feeds.length===0) return alert('No feeds found in OPML.');
  // merge
  const existing = new Set(state.feeds.map(f=>f.url));
  feeds.forEach(f=>{ if(!existing.has(f.url)) state.feeds.push(f); });
  renderFeeds();
});

fileInput.addEventListener('change', async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  const text = await file.text();
  opmlArea.value = text;
  const feeds = parseOPMLText(text);
  if(feeds.length>0){
    const existing = new Set(state.feeds.map(f=>f.url));
    feeds.forEach(f=>{ if(!existing.has(f.url)) state.feeds.push(f); });
    renderFeeds();
  }else{
    alert('No feeds detected in file.');
  }
});

// saving to local storage
saveListBtn.addEventListener('click', ()=>{
  if(state.feeds.length===0) return alert('No feeds to save.');
  localStorage.setItem('aiFeedExplorer.feeds', JSON.stringify(state.feeds));
  alert('Saved to local storage.');
});
loadListBtn.addEventListener('click', ()=>{
  const raw = localStorage.getItem('aiFeedExplorer.feeds');
  if(!raw) return alert('No saved list found.');
  try{
    state.feeds = JSON.parse(raw);
    renderFeeds();
  }catch(e){ alert('Corrupt saved data'); }
});
clearSavedBtn.addEventListener('click', ()=>{
  if(confirm('Clear saved feed list?')){
    localStorage.removeItem('aiFeedExplorer.feeds');
    alert('Saved cleared.');
  }
});

// Helper escape
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }
function debounce(fn, t){ let tid; return (...a)=>{ clearTimeout(tid); tid=setTimeout(()=>fn(...a), t); }; }

// initial demo: populate OPML sample
opmlArea.value = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
  <head><title>Sample AI Feeds</title></head>
  <body>
    <outline text="AI" title="AI">
      <outline type="rss" text="OpenAI Blog" title="OpenAI Blog" xmlUrl="https://openai.com/blog/rss/"/>
      <outline type="rss" text="AI Weekly" title="AI Weekly" xmlUrl="https://www.getrevue.co/profile/aiweekly/rss"/>
      <outline type="rss" text="ArXiv cs.AI" title="ArXiv cs.AI" xmlUrl="https://export.arxiv.org/rss/cs.AI"/>
    </outline>
  </body>
</opml>`;
document.querySelector('#parse').click();
</script>
</body>
</html>
